import SwiftUI
import FirebaseDatabase
import FirebaseAuth

extension Color {
    static let smartChefRed = Color(red: 0.85, green: 0.1, blue: 0.1)
    static let smartChefLightGray = Color(UIColor.systemGray6)
}
struct ContentView: View {
    var body: some View {
        NavigationView {
            SignUpView()
        }
    }
}

struct SignUpView: View {
    @State private var fname: String = ""
    @State private var lname: String = ""
    @State private var username: String = ""
    @State private var email: String = ""
    @State private var password: String = ""
    @State private var confirmPassword: String = ""
    @State private var errorMessage: String = ""
    @State private var isAuthenticated: Bool = false
    
    
    var body: some View {
        NavigationStack {
            VStack {
                Text("SMARTCHEF")
                    .font(.largeTitle)
                    .bold()
                    .foregroundColor(.red)
                    .padding(.bottom, 40)
                
                
                Group {
                    TextField("First Name", text: $fname)
                    TextField("Last Name", text: $lname)
                    TextField("Username", text: $username)
                    TextField("Email", text: $email)
                    SecureField("Password", text: $password)
                    SecureField("Confirm Password", text: $confirmPassword)
                }
                .textFieldStyle(RoundedBorderTextFieldStyle())
                .padding(.horizontal)
                
                
                if !errorMessage.isEmpty {
                    Text(errorMessage)
                        .foregroundColor(.red)
                        .padding()
                }
                
                
                Button("Sign Up") {
                    authenticateUser()
                }
                .frame(maxWidth: .infinity)
                .padding()
                .background(Color.red)
                .foregroundColor(.white)
                .cornerRadius(10)
                .padding(.horizontal)
                
                
                NavigationLink("Already have an account? Sign in", destination: SignInView())
                    .padding()
                
                
                NavigationLink("", destination: HomeView(), isActive: $isAuthenticated)
            }
            .padding()
        }
    }
    
    
    func authenticateUser() {
        // Local validation
        guard fname.count >= 3 else {
            errorMessage = "First name must be at least 3 letters."
            return
        }
        guard lname.count >= 4 else {
            errorMessage = "Last name must be at least 4 letters."
            return
        }
        guard isValidUsername(username) else {
            errorMessage = "Username must be 3–10 characters, and include letters and numbers."
            return
        }
        guard isValidEmail(email) else {
            errorMessage = "Email must be from gmail, outlook, hotmail, icloud, or yahoo."
            return
        }
        guard isValidPassword(password) else {
            errorMessage = "Password must be at least 8 characters and contain a number."
            return
        }
        guard password == confirmPassword else {
            errorMessage = "Passwords do not match."
            return
        }
        // Firebase Authentication
        
        Auth.auth().createUser(withEmail: email, password: password) { result, error in
            if let error = error as NSError? {
                // ... handle errors (as in previous step)
            } else if let user = result?.user {
                // Save user info in Realtime Database
                let ref = Database.database().reference()
                let userData = [
                    "firstName": fname,
                    "lastName": lname,
                    "username": username,
                    "email": email
                ]
                ref.child("users").child(user.uid).setValue(userData) { error, _ in
                    if let error = error {
                        print("❗ Error saving user data: \(error.localizedDescription)")
                        self.errorMessage = "Failed to save user data."
                    } else {
                        print("✅ User data saved successfully.")
                        self.isAuthenticated = true
                    }
                }
            }
        }
    }
}
/*
    func authenticateUser() {
        if fname.count < 3 {
            errorMessage = "First name must be at least 3 letters."
        } else if lname.count < 4 {
            errorMessage = "Last name must be at least 4 letters."
        } else if !isValidUsername(username) {
            errorMessage = "Invalid Username"
        } else if !isValidEmail(email) {
            errorMessage = "Invalid Email!"
        } else if !isValidPassword(password) {
            errorMessage = "Password must be at least 8 characters and contain a number."
        } else if password != confirmPassword {
            errorMessage = "Passwords do not match."
        } else if
            isAuthenticated == true{
        }
        
        else if !isValidEmail(email) {
            errorMessage = "Invalid email. It must contain '@'."
        } else if !isValidPassword(password) {
            errorMessage = "Password must be at least 8 characters and contain a number."
        } else if password != confirmPassword {
            errorMessage = "Passwords do not match."
        } else {
            
            let ref = Database.database().reference()
            let userData = [
                "firstName": fname,
                "lastName": lname,
                "username": username,
                "email": email
            ]
            ref.child("users").childByAutoId().setValue(userData) { error, _ in
                if let error = error {
                    self.errorMessage = "Firebase Error: \(error.localizedDescription)"
                } else {
                    self.isAuthenticated = true
                }
            }
        }
    }
}*/
    


struct SignInView: View {
    @State private var email: String = ""
    @State private var password: String = ""
    @State private var errorMessage: String = ""
    @State private var isAuthenticated: Bool = false


    var body: some View {
        NavigationStack {
            VStack {
                Text("SMARTCHEF")
                    .font(.largeTitle)
                    .bold()
                    .foregroundColor(.red)
                    .padding(.bottom, 40)


                TextField("Email", text: $email)
                    .textFieldStyle(RoundedBorderTextFieldStyle())
                    .padding()


                SecureField("Password", text: $password)
                    .textFieldStyle(RoundedBorderTextFieldStyle())
                    .padding()


                if !errorMessage.isEmpty {
                    Text(errorMessage)
                        .foregroundColor(.red)
                        .padding()
                }


                Button("Sign In") {
                    signInUser()
                }
                .frame(maxWidth: .infinity)
                .padding()
                .background(Color.red)
                .foregroundColor(.white)
                .cornerRadius(10)
                .padding(.horizontal)


                NavigationLink("Forgot your password? Reset", destination: ResetPasswordView())
                    .padding()


                NavigationLink("", destination: HomeView(), isActive: $isAuthenticated)
            }
            .padding()
        }
    }


    func signInUser() {
        Auth.auth().signIn(withEmail: email, password: password) { result, error in
            if let error = error {
                errorMessage = "Sign-in failed: \(error.localizedDescription)"
            } else {
                isAuthenticated = true
            }
        }
    }
}

   
    
    // MARK: - Home Tab View
    struct HomeView: View {
        var body: some View {
            MainTabView()
        }
    }
    struct MainTabView: View {
        var body: some View {
            TabView {
                CommunityView()
                    .tabItem {
                        Image(systemName: "person.3.fill")
                        Text("Community")
                    }
                ChatGPTPromptView()
                    .tabItem {
                        Image(systemName: "plus.circle")
                        Text("Create")
                    }
                ProfileView()
                    .tabItem {
                        Image(systemName: "person.crop.circle")
                        Text("Profile")
                    }
            }
        }
    }
    // MARK: - Recipe Model & Detail View
    struct Recipe: Identifiable {
        let id = UUID()
        let title: String
        let imageName: String
        let calories: Int
        let description: String
        let ingredients: String
        let allergies: [String]
        let measurements: String
        let steps: [String]
    }
    
    struct RecipeDetailView: View {
        let recipe: Recipe
        @State private var showSteps = false
        
        var body: some View {
            ScrollView {
                VStack(spacing: 20) {
                    Image(recipe.imageName)
                        .resizable()
                        .scaledToFit()
                        .frame(height: 200)
                        .clipShape(RoundedRectangle(cornerRadius: 16))
                    
                    Text(recipe.title)
                        .font(.title2)
                        .bold()
                    
                    Text("\(recipe.calories) kcal")
                        .foregroundColor(.smartChefRed)
                        .font(.headline)
                    
                    VStack(alignment: .leading, spacing: 10) {
                        Text("Details")
                            .font(.headline)
                        Text(recipe.description)
                            .font(.subheadline)
                            .foregroundColor(.gray)
                        
                        Text("Ingredients")
                            .font(.headline)
                        Text(recipe.ingredients)
                            .font(.subheadline)
                        
                        Text("Measurements")
                            .font(.headline)
                        Text(recipe.measurements)
                            .font(.subheadline)
                        
                        DisclosureGroup("Steps", isExpanded: $showSteps) {
                            VStack(alignment: .leading, spacing: 8) {
                                ForEach(recipe.steps.indices, id: \ .self) { index in
                                    Text("\(index + 1). \(recipe.steps[index])")
                                        .font(.subheadline)
                                }
                            }
                            .padding(.top, 4)
                        }
                        .font(.headline)
                        
                        if !recipe.allergies.isEmpty {
                            Text("Allergies")
                                .font(.headline)
                                .foregroundColor(.red)
                            Text(recipe.allergies.joined(separator: ", "))
                                .font(.subheadline)
                                .foregroundColor(.red)
                        }
                    }
                    .padding(.horizontal)
                    
                    Button(action: {}) {
                        Text("Add to favorites")
                            .font(.headline)
                            .frame(maxWidth: .infinity)
                            .padding()
                            .background(Color.smartChefRed)
                            .foregroundColor(.white)
                            .cornerRadius(12)
                            .padding(.horizontal)
                    }
                    .padding(.bottom)
                }
                .padding()
            }
            .navigationTitle("")
            .navigationBarTitleDisplayMode(.inline)
        }
    }
    
    // MARK: - Community View
    struct CommunityView: View {
        @State private var showAddRecipe = false
        
        let recipes = [
            Recipe(title: "Veggie tomato mix", imageName: "veggie_tomato", calories: 320, description: "A mix of vegetables perfect for any evening snack.", ingredients: "Vegetables, tomatoes", allergies: ["Tomatoes"], measurements: "1 cup chopped veggies, 2 tomatoes", steps: ["Wash and chop all vegetables.", "Heat pan and sauté vegetables for 5–7 minutes.", "Add tomatoes and cook for another 3 minutes.", "Serve warm."]),
            Recipe(title: "Egg and cucumber", imageName: "egg_cucumber", calories: 290, description: "Light and healthy meal with boiled eggs and cucumbers.", ingredients: "Eggs, cucumber", allergies: ["Eggs"], measurements: "2 eggs, 1 cucumber sliced", steps: ["Boil eggs for 10 minutes.", "Peel and slice eggs.", "Serve with sliced cucumber and a pinch of salt."]),
            Recipe(title: "Fried chicken mix", imageName: "fried_chicken", calories: 450, description: "Crispy fried chicken with a mix of spices.", ingredients: "Chicken, spices", allergies: ["Spices"], measurements: "500g chicken, 1 tsp each of paprika, garlic, salt", steps: ["Season chicken with spices.", "Heat oil in pan.", "Fry chicken until golden and crispy.", "Drain and serve."]),
            Recipe(title: "Moi-moi and ekpa", imageName: "moi_moi_ekpa", calories: 400, description: "Classic Nigerian dish with beans and oil.", ingredients: "Beans, oil", allergies: ["None"], measurements: "1 cup blended beans, 2 tbsp red palm oil", steps: ["Mix blended beans with oil and seasonings.", "Pour into containers and steam for 45 minutes.", "Serve with plantains or rice."]),
            Recipe(title: "Grilled veggie wrap", imageName: "veggie_wrap", calories: 270, description: "Grilled wrap with seasonal vegetables.", ingredients: "Tortilla, veggies", allergies: ["Gluten"], measurements: "1 tortilla, 1 cup mixed veggies", steps: ["Grill vegetables until tender.", "Warm tortilla and place veggies inside.", "Wrap tightly and serve."]),
            Recipe(title: "Avocado toast", imageName: "avocado_toast", calories: 250, description: "Toasted bread topped with mashed avocado.", ingredients: "Bread, avocado", allergies: ["Gluten"], measurements: "2 slices bread, 1 ripe avocado", steps: ["Toast bread slices.", "Mash avocado with lemon and salt.", "Spread on toast and enjoy."])
        ]
        
        var body: some View {
            NavigationStack {
                VStack(alignment: .leading) {
                    HStack {
                        Text("Community")
                            .font(.largeTitle)
                            .bold()
                            .foregroundColor(.smartChefRed)
                        
                        Spacer()
                        
                        Button(action: {
                            showAddRecipe = true
                        }) {
                            Image(systemName: "plus")
                                .font(.title2)
                                .padding(8)
                                .background(Color.smartChefRed)
                                .foregroundColor(.white)
                                .clipShape(Circle())
                        }
                        .padding(.trailing)
                    }
                    .padding([.top, .leading])
                    
                    Text("Total \(recipes.count) results")
                        .font(.headline)
                        .padding(.horizontal)
                        .padding(.bottom, 5)
                    
                    ScrollView {
                        LazyVGrid(columns: [
                            GridItem(.flexible()),
                            GridItem(.flexible())
                        ], spacing: 20) {
                            ForEach(recipes) { recipe in
                                NavigationLink(destination: RecipeDetailView(recipe: recipe)) {
                                    VStack(spacing: 10) {
                                        ZStack {
                                            RoundedRectangle(cornerRadius: 20)
                                                .fill(Color.white)
                                                .shadow(radius: 4)
                                            
                                            VStack(spacing: 10) {
                                                Image(recipe.imageName)
                                                    .resizable()
                                                    .scaledToFit()
                                                    .frame(height: 80)
                                                    .clipShape(RoundedRectangle(cornerRadius: 10))
                                                
                                                Text(recipe.title)
                                                    .font(.headline)
                                                    .multilineTextAlignment(.center)
                                                    .foregroundColor(.black)
                                                
                                                Text("\(recipe.calories) kcal")
                                                    .font(.subheadline)
                                                    .foregroundColor(.smartChefRed)
                                                
                                                if !recipe.allergies.isEmpty {
                                                    Text("Allergies: \(recipe.allergies.joined(separator: ", "))")
                                                        .font(.caption)
                                                        .foregroundColor(.red)
                                                }
                                            }
                                            .padding()
                                        }
                                        .frame(height: 220)
                                    }
                                }
                            }
                        }
                        .padding(.horizontal)
                    }
                }
                .sheet(isPresented: $showAddRecipe) {
                    Text("Share a new recipe (Coming soon)")
                        .font(.title)
                        .padding()
                }
            }
        }
    }
    
    
    
    struct CreateRecipeView: View {
        @State private var navigateToPrompt = false
        
        var body: some View {
            VStack(spacing: 20) {
                Text("Create or View Recipes")
                    .font(.title)
                    .bold()
                    .foregroundColor(.smartChefRed)
                    .padding(.top)
                
                Button(action: {
                    navigateToPrompt = true
                }) {
                    Text("Create New Recipe")
                        .font(.headline)
                        .frame(maxWidth: .infinity)
                        .padding()
                        .background(Color.smartChefRed)
                        .foregroundColor(.white)
                        .cornerRadius(12)
                        .padding(.horizontal)
                }
                
                Button("View Previous Recipes") {
                    // TODO: Navigate to previous recipes view
                }
                .font(.headline)
                .frame(maxWidth: .infinity)
                .padding()
                .background(Color.smartChefRed)
                .foregroundColor(.white)
                .cornerRadius(12)
                .padding(.horizontal)
                
                Spacer()
            }
            .navigationDestination(isPresented: $navigateToPrompt) {
                ChatGPTPromptView()
            }
        }
    }
    
struct ChatGPTPromptView: View {
    @State private var ingredients: [IngredientEntry] = [IngredientEntry()]
    @State private var generatedRecipe: String = ""
    @State private var isLoading = false
    @State private var dietType: String = "Any"
    @State private var previousRecipes: [String] = []

    let dietOptions = ["Any", "Low Carbs", "High Carbs", "High Protein", "Low Calories", "High Calories"]
    let units = ["g", "ml", "oz", "Pc"]

    var body: some View {
        NavigationStack {
            ScrollView {
                VStack(spacing: 20) {
                    HeaderView()
                    IngredientsSection(ingredients: $ingredients, units: units)
                    DietMenu(dietType: $dietType, options: dietOptions)
                    GenerateButton(isLoading: $isLoading, action: generateRecipe)

                    if !generatedRecipe.isEmpty {
                        RecipeOutputView(recipe: generatedRecipe)
                    }

                    NavigationLink(destination: ViewPreviousRecipes()) {
                        Text("View Previous Recipes")
                            .font(.headline)
                            .frame(maxWidth: .infinity)
                            .padding()
                            .background(Color.smartChefRed)
                            .foregroundColor(.white)
                            .cornerRadius(12)
                            .padding(.horizontal)
                    }
                }
                .padding(.top)
            }
            .background(Color.white)
            .ignoresSafeArea(.keyboard, edges: .bottom)
        }
    }

    func generateRecipe() {
        isLoading = true
        let filledIngredients = ingredients.filter { !$0.name.isEmpty }
        let formattedIngredients = filledIngredients
            .map { "\($0.amount) \($0.unit) \($0.name)" }
            .joined(separator: ", ")
        let prompt = """
        Validate if the following are real ingredients: \(formattedIngredients).
        Then create a \(dietType) recipe using these ingredients.
        Provide detailed cooking instructions and include macros (Calories, Proteins, Carbs, Fats). Mention that the macros are approximate.
        """

        ChatGPTService.shared.generateRecipe(prompt: prompt) { response in
            DispatchQueue.main.async {
                if let recipe = response {
                    self.generatedRecipe = recipe
                    self.previousRecipes.append(recipe)
                    saveRecipeToDatabase(recipe)
                } else {
                    self.generatedRecipe = "⚠️ Failed to generate recipe. Please try again later."
                }
                self.isLoading = false
            }
        }
    }

    func saveRecipeToDatabase(_ recipe: String) {
        guard let uid = Auth.auth().currentUser?.uid else { return }
        let ref = Database.database().reference()
            .child("past_recipes")
            .child(uid)
            .childByAutoId()

        let recipeData: [String: Any] = [
            "recipe": recipe,
            "timestamp": Date().timeIntervalSince1970
        ]

        ref.setValue(recipeData)
    }
}

struct IngredientEntry: Identifiable, Equatable {
    var id = UUID()
    var name: String = ""
    var amount: String = ""
    var unit: String = ""
    var amountError: String = ""
}

struct HeaderView: View {
    var body: some View {
        Text("Create or View Recipes")
            .font(.title)
            .bold()
            .foregroundColor(.smartChefRed)
            .padding(.top)
    }
}

struct IngredientsSection: View {
    @Binding var ingredients: [IngredientEntry]
    let units: [String]

    var body: some View {
        VStack(spacing: 10) {
            HStack {
                Text("Ingredients")
                    .frame(maxWidth: .infinity, alignment: .leading)
                Text("Amount")
                    .frame(width: 70)
                Text("Unit")
                    .frame(width: 60)
            }
            .font(.headline)
            .padding(.horizontal)

            ForEach(ingredients.indices, id: \.self) { index in
                HStack(spacing: 10) {
                    TextField("Ingredient", text: $ingredients[index].name)
                        .textFieldStyle(RoundedBorderTextFieldStyle())
                        .autocapitalization(.words)
                        .onChange(of: ingredients[index].name) { newValue in
                            ingredients[index].name = newValue.filter { $0.isLetter || $0.isWhitespace }
                            if !newValue.isEmpty && index == ingredients.count - 1 {
                                ingredients.append(IngredientEntry())
                            }
                        }

                    VStack(alignment: .leading, spacing: 4) {
                        TextField("Amount", text: $ingredients[index].amount)
                            .textFieldStyle(RoundedBorderTextFieldStyle())
                            .keyboardType(.numberPad)
                            .frame(width: 60)
                            .onChange(of: ingredients[index].amount) { newValue in
                                ingredients[index].amount = newValue.filter { $0.isNumber }
                                if ingredients[index].amount.isEmpty || ingredients[index].amount == "0" {
                                    ingredients[index].amountError = "❗ Enter a valid amount"
                                } else {
                                    ingredients[index].amountError = ""
                                }
                            }

                        if !ingredients[index].amountError.isEmpty {
                            Text(ingredients[index].amountError)
                                .font(.caption)
                                .foregroundColor(.red)
                        }
                    }

                    Menu {
                        ForEach(units, id: \.self) { unit in
                            Button(unit) {
                                ingredients[index].unit = unit
                            }
                        }
                    } label: {
                        HStack {
                            Text(ingredients[index].unit.isEmpty ? "Unit" : ingredients[index].unit)
                            Image(systemName: "chevron.down")
                        }
                        .frame(width: 60)
                        .padding(8)
                        .background(Color.smartChefLightGray)
                        .cornerRadius(8)
                    }
                }
                .padding(.horizontal)
            }
        }
    }
}

struct DietMenu: View {
    @Binding var dietType: String
    let options: [String]

    var body: some View {
        Menu {
            ForEach(options, id: \.self) { option in
                Button(option) {
                    dietType = option
                }
            }
        } label: {
            HStack {
                Text("Diet: \(dietType)")
                Image(systemName: "chevron.down")
            }
            .frame(maxWidth: .infinity)
            .padding()
            .background(Color.smartChefLightGray)
            .cornerRadius(12)
            .padding(.horizontal)
        }
    }
}

struct GenerateButton: View {
    @Binding var isLoading: Bool
    var action: () -> Void

    var body: some View {
        Button(action: action) {
            HStack {
                if isLoading {
                    ProgressView().progressViewStyle(CircularProgressViewStyle(tint: .white))
                } else {
                    Text("Generate Recipe!")
                        .font(.headline)
                }
            }
            .frame(maxWidth: .infinity)
            .padding()
            .background(isLoading ? Color.gray : Color.smartChefRed)
            .foregroundColor(.white)
            .cornerRadius(12)
            .padding(.horizontal)
        }
        .disabled(isLoading)
    }
}

struct RecipeOutputView: View {
    let recipe: String

    var body: some View {
        ScrollView {
            Text(recipe)
                .padding()
                .background(Color.smartChefLightGray)
                .cornerRadius(12)
                .padding()
        }
    }
}
struct ViewPreviousRecipes: View {
    @State private var recipes: [String] = []
    @State private var isLoading = true
    @State private var errorMessage = ""
    @State private var successMessage = ""

    var body: some View {
        ScrollView {
            VStack(spacing: 20) {
                Text("Previous Recipes")
                    .font(.largeTitle)
                    .bold()
                    .foregroundColor(.smartChefRed)
                    .padding(.top)

                if isLoading {
                    ProgressView("Loading...").padding()
                } else if !errorMessage.isEmpty {
                    Text(errorMessage)
                        .foregroundColor(.red)
                        .padding()
                } else if recipes.isEmpty {
                    Text("No previous recipes yet.")
                        .foregroundColor(.gray)
                        .padding()
                } else {
                    ForEach(recipes, id: \.self) { recipe in
                        VStack(alignment: .leading, spacing: 10) {
                            Text(recipe)
                                .padding()
                                .background(Color.smartChefLightGray)
                                .cornerRadius(12)

                            Button(action: {
                                addToFavorites(recipe)
                            }) {
                                Label("Favorite", systemImage: "heart")
                                    .font(.subheadline)
                                    .padding(.vertical, 8)
                                    .frame(maxWidth: .infinity)
                                    .background(Color.red.opacity(0.8))
                                    .foregroundColor(.white)
                                    .cornerRadius(10)
                            }
                        }
                        .padding(.horizontal)
                    }

                    if !successMessage.isEmpty {
                        Text(successMessage)
                            .foregroundColor(.green)
                            .font(.caption)
                            .padding(.top, 10)
                    }
                }
            }
            .padding()
        }
        .onAppear {
            fetchRecipesFromFirebase()
        }
    }

    func fetchRecipesFromFirebase() {
        guard let uid = Auth.auth().currentUser?.uid else {
            errorMessage = "User not authenticated."
            isLoading = false
            return
        }

        let ref = Database.database().reference().child("past_recipes").child(uid)
        ref.observeSingleEvent(of: .value) { snapshot in
            var loadedRecipes: [String] = []
            for child in snapshot.children {
                if let childSnapshot = child as? DataSnapshot,
                   let dict = childSnapshot.value as? [String: Any],
                   let recipeText = dict["recipe"] as? String {
                    loadedRecipes.append(recipeText)
                }
            }
            self.recipes = loadedRecipes.reversed()
            self.isLoading = false
        } withCancel: { error in
            self.errorMessage = "Failed to fetch recipes: \(error.localizedDescription)"
            self.isLoading = false
        }
    }

    func addToFavorites(_ recipe: String) {
        guard let uid = Auth.auth().currentUser?.uid else {
            successMessage = "Login required to favorite."
            return
        }

        let ref = Database.database().reference()
            .child("favored_recipes")
            .child(uid)
            .childByAutoId()

        ref.setValue(["recipe": recipe]) { error, _ in
            if let error = error {
                successMessage = "❌ Failed: \(error.localizedDescription)"
            } else {
                successMessage = "✅ Added to favorites!"
            }

            DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
                successMessage = ""
            }
        }
    }
}

    
struct ProfileView: View {
    @AppStorage("isAuthenticated") var isAuthenticated: Bool = true
    @State private var navigateTo: String? = nil
    @State private var fname : String = ""
    @State private var lname : String = ""

    var body: some View {
        NavigationStack {
            VStack(spacing: 0) {
                ScrollView {
                    VStack(spacing: 20) {
                        // Profile Header
                        VStack(spacing: 8) {
                            Spacer().frame(height: 50)
                            Image(systemName: "person.crop.circle")
                                .resizable()
                                .frame(width: 80, height: 80)
                                .foregroundColor(.smartChefRed)
                            
                            
                            Text("\(fname.uppercased()) \(lname.uppercased())")
                                .font(.title2)
                                .bold()
                                .foregroundColor(.black)
                        }
                        .padding(.top, 20)
                        
                        
                        // Profile Buttons
                        VStack(spacing: 16) {
                            Button { navigateTo = "EditProfile" } label: {
                                ProfileRow(icon: "person", title: "Edit Profile")
                            }
                            
                            
                            Button { navigateTo = "Favorites" } label: {
                                ProfileRow(icon: "heart", title: "Favorites")
                            }
                            
                            
                            Button { navigateTo = "MyPosts" } label: {
                                ProfileRow(icon: "doc.text", title: "My Posts")
                            }
                            
                            
                            Button { navigateTo = "Help" } label: {
                                ProfileRow(icon: "questionmark.circle", title: "Help")
                            }
                        }
                        
                        
                        Spacer().frame(height: 100) // Space for logout button
                    }
                }
                
                
                // Log Out Button at bottom
                VStack {
                    Button {
                        isAuthenticated = false
                        navigateTo = "Logout"
                    } label: {
                        HStack {
                            Image(systemName: "arrowshape.turn.up.left")
                                .foregroundColor(.smartChefRed)
                            Text("Log Out")
                                .foregroundColor(.smartChefRed)
                                .fontWeight(.bold)
                        }
                        .frame(maxWidth: .infinity, alignment: .leading)
                        .padding()
                        .background(Color.smartChefLightGray)
                        .cornerRadius(12)
                        .padding(.horizontal)
                    }
                    NavigationLink(destination: SignInView(), tag: "Logout", selection: $navigateTo) { EmptyView() }
                }
                .padding(.bottom, 20)
            }
            .navigationTitle("Profile")
            .navigationBarTitleDisplayMode(.inline)
            .background(Color.white.edgesIgnoringSafeArea(.all))
            
            
            // Navigation destinations
            NavigationLink(destination: EditProfileView(), tag: "EditProfile", selection: $navigateTo) { EmptyView() }
            NavigationLink(destination: FavoritesView(), tag: "Favorites", selection: $navigateTo) { EmptyView() }
            NavigationLink(destination: MyPostsView(), tag: "MyPosts", selection: $navigateTo) { EmptyView() }
            NavigationLink(destination: HelpView(), tag: "Help", selection: $navigateTo) { EmptyView() }
        }
        .onAppear{
            loadUserProfile()
        }
    }
        func loadUserProfile() {
            guard let uid = Auth.auth().currentUser?.uid else { return }
            let ref = Database.database().reference().child("users").child(uid)
            ref.observeSingleEvent(of: .value) { snapshot in
                if let data = snapshot.value as? [String: Any] {
                    fname = data["firstName"] as? String ?? ""
                    lname = data["lastName"] as? String ?? ""
                }
            }
    }
}


// MARK: - Profile Row UI
struct ProfileRow: View {
    var icon: String
    var title: String


    var body: some View {
        HStack(spacing: 12) {
            Image(systemName: icon)
                .foregroundColor(.smartChefRed)
                .frame(width: 24, height: 24)
            Text(title)
                .foregroundColor(.black)
            Spacer()
        }
        .padding()
        .background(Color.smartChefLightGray)
        .cornerRadius(12)
        .padding(.horizontal)
    }
}


// MARK: - Placeholder Views


 struct EditProfileView: View {
    @State private var firstName = ""
    @State private var lastName = ""
    @State private var newPassword = ""
    @State private var confirmPassword = ""
    @State private var errorMessage = ""
    @State private var successMessage = ""

    var body: some View {
        VStack(spacing: 20) {
            Text("Edit Profile")
                .font(.largeTitle)
                .bold()

            TextField("First Name", text: $firstName)
                .textFieldStyle(RoundedBorderTextFieldStyle())
                .padding(.horizontal)

            TextField("Last Name", text: $lastName)
                .textFieldStyle(RoundedBorderTextFieldStyle())
                .padding(.horizontal)

            SecureField("New Password", text: $newPassword)
                .textFieldStyle(RoundedBorderTextFieldStyle())
                .padding(.horizontal)

            SecureField("Confirm Password", text: $confirmPassword)
                .textFieldStyle(RoundedBorderTextFieldStyle())
                .padding(.horizontal)

            if !errorMessage.isEmpty {
                Text(errorMessage)
                    .foregroundColor(.red)
                    .multilineTextAlignment(.center)
                    .padding(.horizontal)
            }

            if !successMessage.isEmpty {
                Text(successMessage)
                    .foregroundColor(.green)
                    .multilineTextAlignment(.center)
                    .padding(.horizontal)
            }

            Button("Save Changes") {
                saveProfileChanges()
            }
            .padding()
            .background(Color.smartChefRed)
            .foregroundColor(.white)
            .cornerRadius(10)

            Spacer()
        }
        .padding()
        .onAppear {
            loadUserData()
        }
    }

    // MARK: - Validation
    func isValidPassword(_ password: String) -> Bool {
        return password.count >= 8 && password.rangeOfCharacter(from: .decimalDigits) != nil
    }

    // MARK: - Load Profile Data
    func loadUserData() {
        guard let uid = Auth.auth().currentUser?.uid else { return }
        let ref = Database.database().reference().child("users").child(uid)
        ref.observeSingleEvent(of: .value) { snapshot in
            if let data = snapshot.value as? [String: Any] {
                firstName = data["firstName"] as? String ?? ""
                lastName = data["lastName"] as? String ?? ""
            }
        }
    }

    // MARK: - Save Profile Changes
    func saveProfileChanges() {
        errorMessage = ""
        successMessage = ""

        // Handle password validation if fields are not empty
        if !newPassword.isEmpty || !confirmPassword.isEmpty {
            if newPassword != confirmPassword {
                errorMessage = "Passwords do not match."
                return
            }
            if !isValidPassword(newPassword) {
                errorMessage = "Password must be at least 8 characters and include a number."
                return
            }
            updatePassword()
        }

        updateUserProfile()
    }

    // MARK: - Update Name Fields in Firebase
    func updateUserProfile() {
        guard let uid = Auth.auth().currentUser?.uid else {
            errorMessage = "User not authenticated."
            return
        }

        let ref = Database.database().reference().child("users").child(uid)
        let updates = [
            "firstName": firstName,
            "lastName": lastName
        ]

        ref.updateChildValues(updates) { error, _ in
            if let error = error {
                errorMessage = "Update failed: \(error.localizedDescription)"
            } else {
                successMessage = "Profile updated successfully!"
            }
        }
    }

    // MARK: - Update Password with FirebaseAuth
    func updatePassword() {
        Auth.auth().currentUser?.updatePassword(to: newPassword) { error in
            if let error = error {
                errorMessage = "Password update failed: \(error.localizedDescription)"
            } else {
                successMessage = "Password updated successfully!"
            }
        }
    }
}

struct FavoritesView: View {
    @State private var recipes: [(id: String, text: String)] = []
    @State private var isLoading = true
    @State private var errorMessage = ""
    @State private var isSelectionMode = false
    @State private var selectedIDs: Set<String> = []

    var body: some View {
        NavigationStack {
            VStack(spacing: 20) {
                if isLoading {
                    ProgressView("Loading favorites...").padding()
                } else if !errorMessage.isEmpty {
                    Text(errorMessage)
                        .foregroundColor(.red)
                        .padding()
                } else if recipes.isEmpty {
                    Text("No favorite recipes.")
                        .foregroundColor(.gray)
                        .padding()
                } else {
                    ScrollView {
                        ForEach(recipes, id: \.id) { recipe in
                            HStack {
                                if isSelectionMode {
                                    Image(systemName: selectedIDs.contains(recipe.id) ? "checkmark.circle.fill" : "circle")
                                        .foregroundColor(.smartChefRed)
                                        .onTapGesture {
                                            toggleSelection(for: recipe.id)
                                        }
                                }

                                VStack(alignment: .leading, spacing: 5) {
                                    Text(recipe.text)
                                        .padding()
                                        .background(Color.smartChefLightGray)
                                        .cornerRadius(12)
                                }

                                Spacer()
                            }
                            .padding(.horizontal)
                        }
                    }
                }

                if isSelectionMode && !selectedIDs.isEmpty {
                    Button(role: .destructive) {
                        deleteSelectedFavorites()
                    } label: {
                        Label("Delete Selected", systemImage: "trash")
                            .frame(maxWidth: .infinity)
                            .padding()
                            .background(Color.red.opacity(0.9))
                            .foregroundColor(.white)
                            .cornerRadius(12)
                            .padding(.horizontal)
                    }
                    .transition(.opacity)
                }
            }
            .padding(.top)
            .navigationTitle("Favorites")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button(action: {
                        withAnimation {
                            isSelectionMode.toggle()
                            selectedIDs.removeAll()
                        }
                    }) {
                        Image(systemName: isSelectionMode ? "xmark.circle" : "trash")
                            .foregroundColor(.smartChefRed)
                    }
                }
            }
            .onAppear {
                fetchFavorites()
            }
        }
    }

    // MARK: - Firebase Fetch
    func fetchFavorites() {
        guard let uid = Auth.auth().currentUser?.uid else {
            self.errorMessage = "User not authenticated."
            self.isLoading = false
            return
        }

        let ref = Database.database().reference().child("favored_recipes").child(uid)
        ref.observeSingleEvent(of: .value) { snapshot in
            var loaded: [(id: String, text: String)] = []
            for child in snapshot.children {
                if let snap = child as? DataSnapshot,
                   let dict = snap.value as? [String: Any],
                   let recipeText = dict["recipe"] as? String {
                    loaded.append((id: snap.key, text: recipeText))
                }
            }
            self.recipes = loaded.reversed()
            self.isLoading = false
        } withCancel: { error in
            self.errorMessage = "Failed to load favorites: \(error.localizedDescription)"
            self.isLoading = false
        }
    }

    // MARK: - Selection
    func toggleSelection(for id: String) {
        if selectedIDs.contains(id) {
            selectedIDs.remove(id)
        } else {
            selectedIDs.insert(id)
        }
    }

    // MARK: - Delete
    func deleteSelectedFavorites() {
        guard let uid = Auth.auth().currentUser?.uid else { return }

        let ref = Database.database().reference().child("favored_recipes").child(uid)
        for id in selectedIDs {
            ref.child(id).removeValue()
        }

        // Remove locally
        recipes.removeAll { selectedIDs.contains($0.id) }
        selectedIDs.removeAll()
        isSelectionMode = false
    }
}




struct MyPostsView: View {
    var body: some View {
        VStack {
            Text("Your Shared Posts")
                .font(.largeTitle)
                .padding()
            // Populate user's shared posts here
            Spacer()
        }
    }
}


struct HelpView: View {
    var body: some View {
        VStack {
            Spacer ()
            Text("Tech support: help@smartchef.com")
                .multilineTextAlignment(.center)
                .font(.title2)
                .foregroundColor(.gray)
                .padding()
            Spacer()
        }
    }
}

    
    
    
    
    // MARK: - Password Reset & Confirmation
    struct ResetPasswordView: View {
        @State private var email: String = ""
        @State private var isEmailValid: Bool = false
        @State private var errorMessage: String = ""
        var body: some View {
            NavigationStack {
                VStack {
                    Text("SMARTCHEF")
                        .font(.largeTitle)
                        .bold()
                        .foregroundColor(.red)
                        .padding(.bottom, 40)
                    TextField("Enter your email", text: $email)
                        .textFieldStyle(RoundedBorderTextFieldStyle())
                        .padding()
                    if !errorMessage.isEmpty {
                        Text(errorMessage)
                            .foregroundColor(.red)
                            .padding()
                    }
                    Button(action: {
                        validateEmail()
                    }) {
                        Text("Send Reset Email")
                            .frame(maxWidth: .infinity)
                            .padding()
                            .background(Color.red)
                            .foregroundColor(.white)
                            .cornerRadius(10)
                            .padding(.horizontal)
                    }
                    NavigationLink("", destination: ConfirmationView(), isActive: $isEmailValid)
                }
                .padding()
            }
        }
        func validateEmail() {
            if isValidEmail(email) {
                isEmailValid = true
            } else {
                errorMessage = "Invalid email format. Please enter a valid email."
            }
        }
    }
    struct ConfirmationView: View {
        var body: some View {
            NavigationStack {
                VStack {
                    Text("SMARTCHEF")
                        .font(.largeTitle)
                        .bold()
                        .foregroundColor(.red)
                        .padding()
                    Text("The Email has been sent!")
                        .multilineTextAlignment(.center)
                        .padding()
                    Image(systemName: "checkmark.circle.fill")
                        .resizable()
                        .scaledToFit()
                        .frame(width: 100, height: 100)
                        .foregroundColor(.red)
                        .padding()
                    NavigationLink(destination: SignInView()) {
                        Text("Sign in")
                            .frame(maxWidth: .infinity)
                            .padding()
                            .background(Color.red)
                            .foregroundColor(.white)
                            .cornerRadius(10)
                            .padding(.horizontal)
                    }
                }
                .padding()
            }
        }
    }
func isValidEmail(_ email: String) -> Bool {
    let allowedDomains = ["gmail.com", "outlook.com", "hotmail.com", "icloud.com", "yahoo.com"]
    guard let domain = email.split(separator: "@").last else { return false }
    return allowedDomains.contains(String(domain))
}
func isValidPassword(_ password: String) -> Bool {
    return password.count >= 8 && password.rangeOfCharacter(from: .decimalDigits) != nil
}
func isValidUsername(_ username: String) -> Bool {
    let regex = "^(?=.*[A-Za-z])(?=.*\\d)[A-Za-z\\d]{3,10}$"
    return NSPredicate(format: "SELF MATCHES %@", regex).evaluate(with: username)
}


    // MARK: - Preview
    #Preview {
        ContentView()
    }

    
    
    
    
    
    
    

